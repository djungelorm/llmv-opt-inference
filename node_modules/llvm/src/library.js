var writeFileSync = require('fs').writeFileSync;
var execSync = require('child_process').execSync;
var exeId = 0;

var compileExecutable = function(program, path_prefix) {
  var path = path_prefix + exeId;
  exeId += 1;
  var ir = compileIR(program);
  writeFileSync(path+".ll", ir);
  var cmd = 'llc -filetype obj -o '+path+'.o '+path+'.ll';
  execSync(cmd, function(error, stdout, stderr) {
    //console.log(error);
    //console.log(stdout);
    //console.log(stderr);
  });
  return path;
};

var compileIR = function(program) {
  var inputs = [];
  var inputs_extract = [];
  for (var idx = 1; idx < program.inputs+1; idx++) {
    inputs.push("i32 %r"+idx);
    inputs_extract.push(
      "  %r"+idx+"_ptr = getelementptr inbounds i8*, i8** %argc, i64 "+idx+"\n" +
      "  %r"+idx+"_str = load i8*, i8** %r"+idx+"_ptr\n" +
      "  %r"+idx+" = call i32 @atoi(i8* %r"+idx+"_str)");
  }
  inputs = inputs.join(', ');
  return [
    "; ModuleID = 'program'", "",
    "declare i32 @atoi(i8*)", "",
    "declare i32 @printf(i8*, ...)", "",
    "@.str = private unnamed_addr constant [4 x i8] c\"%d\\0A\\00\", align 1", "",
    "define void @main(i32 %argv, i8** %argc) {",
    "body:"]
    .concat(inputs_extract)
    .concat(
      "  %r0 = call i32 @program("+inputs+")",
      "  %ignore = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([4 x i8], [4 x i8]* @.str, i32 0, i32 0), i32 %r0)",
      "  ret void",
      "}","")
    .concat(compileProgram(program))
    .join("\n");
};

var compileProgram = function(program) {
  var inputs = [];
  for (var idx = 1; idx < program.inputs+1; idx++)
    inputs.push("i32 %r"+idx);
  var instrs = compileInstrs(program.instrs);
  return ["define i32 @program(" + inputs.join(", ") + ") {", "body:"]
        .concat(instrs)
        .concat("  ret i32 %r0", "}", "");
};

var compileInstrs = function(instrs) {
  var code = '';
  for (var idx = 0; idx < instrs.length; idx++)
    code += compileInstr(instrs[idx]) + '\n';
  return code;
};

var compileInstr = function(instr) {
  var operands = [];
  for (var idx = 0; idx < instr.operands.length; idx++)
    operands.push('%r'+instr.operands[idx]);
  return '  %r'+instr.result+' = '+instr.opcode+' i32 '+operands.join(', ');
};

module.exports = {
  compileExecutable: compileExecutable,
  compileIR: compileIR
};
